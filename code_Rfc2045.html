<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="MrMime" rel="Chapter" href="MrMime.html">
<link title="Newline" rel="Chapter" href="Newline.html">
<link title="Date" rel="Chapter" href="Date.html">
<link title="LiteralDomain" rel="Chapter" href="LiteralDomain.html">
<link title="Address" rel="Chapter" href="Address.html">
<link title="MsgID" rel="Chapter" href="MsgID.html">
<link title="Resent" rel="Chapter" href="Resent.html">
<link title="Trace" rel="Chapter" href="Trace.html">
<link title="MimeVersion" rel="Chapter" href="MimeVersion.html">
<link title="ContentType" rel="Chapter" href="ContentType.html">
<link title="ContentEncoding" rel="Chapter" href="ContentEncoding.html">
<link title="Content" rel="Chapter" href="Content.html">
<link title="Header" rel="Chapter" href="Header.html">
<link title="Message" rel="Chapter" href="Message.html">
<link title="Option" rel="Chapter" href="Option.html">
<link title="Iana" rel="Chapter" href="Iana.html">
<link title="Error" rel="Chapter" href="Error.html">
<link title="Decoder" rel="Chapter" href="Decoder.html">
<link title="BaseDecoder" rel="Chapter" href="BaseDecoder.html">
<link title="Encoder" rel="Chapter" href="Encoder.html">
<link title="BaseEncoder" rel="Chapter" href="BaseEncoder.html">
<link title="Wrap" rel="Chapter" href="Wrap.html">
<link title="Rfc822" rel="Chapter" href="Rfc822.html">
<link title="Rfc5321" rel="Chapter" href="Rfc5321.html">
<link title="Rfc5322" rel="Chapter" href="Rfc5322.html">
<link title="Rfc6854" rel="Chapter" href="Rfc6854.html">
<link title="Rfc2045" rel="Chapter" href="Rfc2045.html">
<link title="Base64" rel="Chapter" href="Base64.html">
<link title="QuotedPrintable" rel="Chapter" href="QuotedPrintable.html">
<link title="Rfc2046" rel="Chapter" href="Rfc2046.html">
<link title="Rfc2047" rel="Chapter" href="Rfc2047.html">
<link title="Grammar" rel="Chapter" href="Grammar.html"><title>Rfc2045</title>
</head>
<body>
<code class="code"><span class="keyword">open</span>&nbsp;<span class="constructor">BaseDecoder</span>

<span class="keyword">type</span>&nbsp;discrete&nbsp;=
&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Application</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Audio</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Image</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Text</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Video</span>&nbsp;]
<span class="keyword">type</span>&nbsp;composite&nbsp;=
&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Message</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Multipart</span>&nbsp;]
<span class="keyword">type</span>&nbsp;other&nbsp;=
&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Ietf_token</span>&nbsp;<span class="keyword">of</span>&nbsp;string
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">X_token</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;]
<span class="keyword">type</span>&nbsp;ty&nbsp;=&nbsp;[&nbsp;discrete&nbsp;<span class="keywordsign">|</span>&nbsp;composite&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;]

<span class="keyword">type</span>&nbsp;subty&nbsp;=
&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Ietf_token</span>&nbsp;<span class="keyword">of</span>&nbsp;string
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Iana_token</span>&nbsp;<span class="keyword">of</span>&nbsp;string
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">X_token</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;]

<span class="keyword">type</span>&nbsp;value&nbsp;=
&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;<span class="keyword">of</span>&nbsp;string
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Token</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;]

<span class="keyword">type</span>&nbsp;content&nbsp;=&nbsp;ty&nbsp;*&nbsp;subty&nbsp;*&nbsp;(string&nbsp;*&nbsp;value)&nbsp;list
<span class="keyword">type</span>&nbsp;version&nbsp;=&nbsp;int&nbsp;*&nbsp;int
<span class="keyword">type</span>&nbsp;encoding&nbsp;=
&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Base64</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Bit7</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Bit8</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Binary</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">QuotedPrintable</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ietf_token</span>&nbsp;<span class="keyword">of</span>&nbsp;string
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">X_token</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;]
<span class="keyword">type</span>&nbsp;id&nbsp;=&nbsp;<span class="constructor">Rfc822</span>.msg_id

<span class="keyword">type</span>&nbsp;field&nbsp;=
&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">ContentType</span>&nbsp;<span class="keyword">of</span>&nbsp;content
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">ContentEncoding</span>&nbsp;<span class="keyword">of</span>&nbsp;encoding
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">ContentID</span>&nbsp;<span class="keyword">of</span>&nbsp;id
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">ContentDescription</span>&nbsp;<span class="keyword">of</span>&nbsp;string
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Content</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;*&nbsp;<span class="constructor">Rfc5322</span>.phrase
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Unsafe</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;*&nbsp;<span class="constructor">Rfc5322</span>.phrase&nbsp;]

<span class="keyword">type</span>&nbsp;mime_field&nbsp;=
&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">MimeVersion</span>&nbsp;<span class="keyword">of</span>&nbsp;int&nbsp;*&nbsp;int&nbsp;]

<span class="keyword">let</span>&nbsp;value_to_string&nbsp;=&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Token</span>&nbsp;s&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s

<span class="keyword">let</span>&nbsp;is_tspecials&nbsp;=&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'('</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">')'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'&lt;'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'&gt;'</span>&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'@'</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">','</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">';'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">':'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'\\'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'"'</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'/'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'['</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">']'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'?'</span>&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'='</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span>

<span class="keyword">let</span>&nbsp;is_token&nbsp;chr&nbsp;=
&nbsp;&nbsp;not&nbsp;(is_tspecials&nbsp;chr)
&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;not&nbsp;(<span class="constructor">Rfc822</span>.is_ctl&nbsp;chr)
&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;not&nbsp;(<span class="constructor">Rfc822</span>.is_space&nbsp;chr)

<span class="keyword">let</span>&nbsp;p_token&nbsp;p&nbsp;state&nbsp;=&nbsp;p_while&nbsp;is_token&nbsp;p&nbsp;state

<span class="keyword">let</span>&nbsp;p_attribute&nbsp;p&nbsp;state&nbsp;=&nbsp;p_token&nbsp;(<span class="keyword">fun</span>&nbsp;token&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(<span class="constructor">String</span>.lowercase_ascii&nbsp;token))&nbsp;state

<span class="keyword">let</span>&nbsp;p_ietf_token&nbsp;p&nbsp;=
&nbsp;&nbsp;p_token
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;token&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(<span class="keywordsign">`</span><span class="constructor">Ietf_token</span>&nbsp;token)

<span class="keyword">let</span>&nbsp;p_iana_token&nbsp;p&nbsp;=
&nbsp;&nbsp;p_token
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;token&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(<span class="keywordsign">`</span><span class="constructor">Iana_token</span>&nbsp;token)

<span class="keyword">let</span>&nbsp;p_x_token&nbsp;p&nbsp;=
&nbsp;&nbsp;p_set&nbsp;[<span class="string">'X'</span>;&nbsp;<span class="string">'x'</span>]
&nbsp;&nbsp;@&nbsp;p_chr&nbsp;<span class="string">'-'</span>
&nbsp;&nbsp;@&nbsp;p_token
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;token&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(<span class="keywordsign">`</span><span class="constructor">X_token</span>&nbsp;token)

<span class="keyword">let</span>&nbsp;p_extension_token&nbsp;p&nbsp;=
&nbsp;&nbsp;cur_chr&nbsp;@&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'X'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'x'</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_x_token&nbsp;p
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;chr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_ietf_token&nbsp;p

<span class="keyword">let</span>&nbsp;p_composite_type&nbsp;p&nbsp;=
&nbsp;&nbsp;p_token&nbsp;@&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"message"</span>&nbsp;&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Message</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"multipart"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Multipart</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;extension_token&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;roll_back&nbsp;(p_extension_token&nbsp;p)&nbsp;extension_token

<span class="keyword">let</span>&nbsp;p_discrete_type&nbsp;p&nbsp;=
&nbsp;&nbsp;p_token&nbsp;@&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"text"</span>&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Text</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"image"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Image</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"audio"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Audio</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"video"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Video</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"application"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Application</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;extension_token&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;roll_back&nbsp;(p_extension_token&nbsp;p)&nbsp;extension_token

<span class="keyword">let</span>&nbsp;p_msg_id&nbsp;=&nbsp;<span class="constructor">Rfc822</span>.p_msg_id

<span class="keyword">let</span>&nbsp;p_type&nbsp;p&nbsp;=
&nbsp;&nbsp;p_token&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;token&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">String</span>.lowercase_ascii&nbsp;token&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;<span class="comment">(*&nbsp;discrete-type&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"text"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Text</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"image"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Image</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"audio"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Audio</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"video"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Video</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"application"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Application</span>
&nbsp;&nbsp;<span class="comment">(*&nbsp;composite-type&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"message"</span>&nbsp;&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Message</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"multipart"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Multipart</span>
&nbsp;&nbsp;<span class="comment">(*&nbsp;extension-type&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;extension_token&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;roll_back&nbsp;(p_extension_token&nbsp;p)&nbsp;extension_token

<span class="keyword">let</span>&nbsp;ty_to_string&nbsp;=&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Text</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"text"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Image</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"image"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Audio</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"audio"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Video</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"video"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Application</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"application"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Message</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"message"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Multipart</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"multipart"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">X_token</span>&nbsp;s&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ietf_token</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s

<span class="keyword">let</span>&nbsp;p_subtype&nbsp;ty&nbsp;p&nbsp;=
&nbsp;&nbsp;cur_chr&nbsp;@&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'X'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'x'</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_extension_token&nbsp;p
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;chr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;p_token
&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;token&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Iana</span>.<span class="constructor">Map</span>.find&nbsp;ty&nbsp;<span class="constructor">Iana</span>.mtype
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Iana</span>.<span class="constructor">Set</span>.find&nbsp;token
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="keyword">fun</span>&nbsp;value&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(<span class="keywordsign">`</span><span class="constructor">Iana_token</span>&nbsp;value)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;exn&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(<span class="keywordsign">`</span><span class="constructor">X_token</span>&nbsp;token)

<span class="keyword">let</span>&nbsp;p_value&nbsp;p&nbsp;=
&nbsp;&nbsp;(<span class="constructor">Rfc822</span>.p_quoted_string&nbsp;(<span class="keyword">fun</span>&nbsp;data&nbsp;state&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ok</span>&nbsp;(data,&nbsp;state)))
&nbsp;&nbsp;/&nbsp;(p_token&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;token&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(<span class="keywordsign">`</span><span class="constructor">Token</span>&nbsp;token))
&nbsp;&nbsp;@&nbsp;(<span class="keyword">fun</span>&nbsp;data&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;data))

<span class="keyword">let</span>&nbsp;p_parameter&nbsp;p&nbsp;=
&nbsp;&nbsp;p_attribute
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;name&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_chr&nbsp;<span class="string">'='</span>
&nbsp;&nbsp;@&nbsp;p_value
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;value&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(name,&nbsp;value)

<span class="keyword">let</span>&nbsp;p_content&nbsp;p&nbsp;=
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;loop&nbsp;p&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;aux&nbsp;acc&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cur_chr&nbsp;@&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">';'</span>&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;junk_chr
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="constructor">Rfc822</span>.p_fws
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_parameter
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;parameter&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_fws
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;aux&nbsp;(parameter&nbsp;::&nbsp;acc)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;chr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(<span class="constructor">List</span>.rev&nbsp;acc)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;aux&nbsp;[]
&nbsp;&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;<span class="constructor">Rfc822</span>.p_cfws
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_type
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;ty&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_chr&nbsp;<span class="string">'/'</span>
&nbsp;&nbsp;@&nbsp;<span class="constructor">Rfc822</span>.p_cfws
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_subtype&nbsp;(ty_to_string&nbsp;ty)
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;subty&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_cfws
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;cur_chr
&nbsp;&nbsp;@&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">';'</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;loop&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;parameters&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_cfws&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(ty,&nbsp;subty,&nbsp;parameters)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;chr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(ty,&nbsp;subty,&nbsp;[])

<span class="keyword">let</span>&nbsp;p_version&nbsp;p&nbsp;=
&nbsp;&nbsp;<span class="constructor">Rfc822</span>.p_cfws
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_while&nbsp;<span class="constructor">Rfc822</span>.is_digit
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">let</span>&nbsp;a&nbsp;=&nbsp;int_of_string&nbsp;a&nbsp;<span class="keyword">in</span>&nbsp;<span class="constructor">Rfc822</span>.p_cfws
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_chr&nbsp;<span class="string">'.'</span>
&nbsp;&nbsp;@&nbsp;<span class="constructor">Rfc822</span>.p_cfws
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_while&nbsp;<span class="constructor">Rfc822</span>.is_digit
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;int_of_string&nbsp;b&nbsp;<span class="keyword">in</span>&nbsp;<span class="constructor">Rfc822</span>.p_cfws
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;(a,&nbsp;b)

<span class="keyword">let</span>&nbsp;p_mechanism&nbsp;p&nbsp;=
&nbsp;&nbsp;p_token&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;token&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">String</span>.lowercase_ascii&nbsp;token&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"7bit"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Bit7</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"8bit"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Bit8</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"binary"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Binary</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"quoted-printable"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">QuotedPrintable</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"base64"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;<span class="keywordsign">`</span><span class="constructor">Base64</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;extension_token&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;[%debug&nbsp;<span class="constructor">Printf</span>.printf&nbsp;<span class="string">"state:&nbsp;p_mechanism&nbsp;(ext&nbsp;token):&nbsp;%S\n%!"</span>&nbsp;extension_token];
&nbsp;&nbsp;&nbsp;&nbsp;roll_back&nbsp;(p_extension_token&nbsp;p)&nbsp;extension_token

<span class="keyword">let</span>&nbsp;p_encoding&nbsp;p&nbsp;=
&nbsp;&nbsp;<span class="constructor">Rfc822</span>.p_cfws
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_mechanism
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_cfws
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;e

<span class="keyword">let</span>&nbsp;p_id&nbsp;p&nbsp;=
&nbsp;&nbsp;<span class="constructor">Rfc822</span>.p_cfws
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_msg_id
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_cfws
&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;m

<span class="keyword">let</span>&nbsp;p_field&nbsp;mime_extend&nbsp;extend&nbsp;field&nbsp;p&nbsp;=
&nbsp;&nbsp;[%debug&nbsp;<span class="constructor">Printf</span>.printf&nbsp;<span class="string">"state:&nbsp;p_field&nbsp;(RFC&nbsp;2045)&nbsp;%s\n%!"</span>&nbsp;field];

&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;field&nbsp;=&nbsp;<span class="constructor">String</span>.lowercase_ascii&nbsp;field&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rule&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;field&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"content-type"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_content&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_crlf&nbsp;@&nbsp;ok&nbsp;(<span class="keywordsign">`</span><span class="constructor">ContentType</span>&nbsp;c)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"content-transfer-encoding"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_encoding&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_crlf&nbsp;@&nbsp;ok&nbsp;(<span class="keywordsign">`</span><span class="constructor">ContentEncoding</span>&nbsp;e)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"content-id"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_id&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;i&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_crlf&nbsp;@&nbsp;p&nbsp;(<span class="keywordsign">`</span><span class="constructor">ContentID</span>&nbsp;i)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"content-description"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_text&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_crlf&nbsp;@&nbsp;ok&nbsp;(<span class="keywordsign">`</span><span class="constructor">ContentDescription</span>&nbsp;s)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;field&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;XXX:&nbsp;the&nbsp;optionnal-field&nbsp;[fields]&nbsp;is&nbsp;handle&nbsp;by&nbsp;RFC&nbsp;822&nbsp;or&nbsp;RFC&nbsp;5322.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in&nbsp;this&nbsp;case,&nbsp;we&nbsp;raise&nbsp;an&nbsp;error.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">String</span>.length&nbsp;field&nbsp;&gt;=&nbsp;8&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;<span class="constructor">String</span>.sub&nbsp;field&nbsp;0&nbsp;8&nbsp;=&nbsp;<span class="string">"content-"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;<span class="keyword">let</span>&nbsp;field&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;field&nbsp;8&nbsp;(<span class="constructor">String</span>.length&nbsp;field&nbsp;-&nbsp;8)&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_try_rule&nbsp;p
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Rfc5322</span>.p_unstructured&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;value&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Rfc822</span>.p_crlf&nbsp;@&nbsp;p&nbsp;(<span class="keywordsign">`</span><span class="constructor">Content</span>&nbsp;(field,&nbsp;value)))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(mime_extend&nbsp;field&nbsp;@&nbsp;ok)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;extend&nbsp;field&nbsp;p
&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;rule
&nbsp;&nbsp;/&nbsp;(<span class="constructor">Rfc5322</span>.p_unstructured
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_crlf
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;p&nbsp;(<span class="keywordsign">`</span><span class="constructor">Unsafe</span>&nbsp;(field,&nbsp;l)))
&nbsp;&nbsp;@&nbsp;p

<span class="keyword">let</span>&nbsp;p_entity_headers&nbsp;extend_mime&nbsp;extend&nbsp;p&nbsp;state&nbsp;=
&nbsp;&nbsp;[%debug&nbsp;<span class="constructor">Printf</span>.printf&nbsp;<span class="string">"state:&nbsp;p_entity_header\n%!"</span>];

&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;loop&nbsp;acc&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Rfc822</span>.p_field_name
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;field&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(0&nbsp;*&nbsp;0)&nbsp;<span class="constructor">Rfc822</span>.is_lwsp
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_chr&nbsp;<span class="string">':'</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;p_field&nbsp;extend_mime&nbsp;extend&nbsp;field
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;data&nbsp;state&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ok</span>&nbsp;(data,&nbsp;state))
&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;(p&nbsp;(<span class="constructor">List</span>.rev&nbsp;acc))
&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;(<span class="keyword">fun</span>&nbsp;field&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;loop&nbsp;(field&nbsp;::&nbsp;acc))
&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;loop&nbsp;[]&nbsp;state

<span class="keyword">let</span>&nbsp;p_mime_message_headers&nbsp;extend_mime&nbsp;extend&nbsp;field&nbsp;p&nbsp;=
&nbsp;&nbsp;[%debug&nbsp;<span class="constructor">Printf</span>.printf&nbsp;<span class="string">"state:&nbsp;p_mime_message_header\n%!"</span>];

&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;field&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"mime-version"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_version&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Rfc822</span>.p_crlf&nbsp;@&nbsp;p&nbsp;(<span class="keywordsign">`</span><span class="constructor">MimeVersion</span>&nbsp;v)
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;field&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p_field&nbsp;extend_mime&nbsp;extend&nbsp;field&nbsp;p

<span class="keyword">let</span>&nbsp;p_mime_part_headers&nbsp;=&nbsp;p_entity_headers

<span class="keyword">module</span>&nbsp;<span class="constructor">Base64</span>&nbsp;=&nbsp;<span class="constructor">Base64</span>
<span class="keyword">module</span>&nbsp;<span class="constructor">QuotedPrintable</span>&nbsp;=&nbsp;<span class="constructor">QuotedPrintable</span>
</code></body></html>