<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="MrMime" rel="Chapter" href="MrMime.html">
<link title="Newline" rel="Chapter" href="Newline.html">
<link title="Date" rel="Chapter" href="Date.html">
<link title="LiteralDomain" rel="Chapter" href="LiteralDomain.html">
<link title="Address" rel="Chapter" href="Address.html">
<link title="MsgID" rel="Chapter" href="MsgID.html">
<link title="Resent" rel="Chapter" href="Resent.html">
<link title="Trace" rel="Chapter" href="Trace.html">
<link title="MimeVersion" rel="Chapter" href="MimeVersion.html">
<link title="ContentType" rel="Chapter" href="ContentType.html">
<link title="ContentEncoding" rel="Chapter" href="ContentEncoding.html">
<link title="Content" rel="Chapter" href="Content.html">
<link title="Header" rel="Chapter" href="Header.html">
<link title="Message" rel="Chapter" href="Message.html">
<link title="Option" rel="Chapter" href="Option.html">
<link title="Iana" rel="Chapter" href="Iana.html">
<link title="Error" rel="Chapter" href="Error.html">
<link title="Decoder" rel="Chapter" href="Decoder.html">
<link title="BaseDecoder" rel="Chapter" href="BaseDecoder.html">
<link title="Encoder" rel="Chapter" href="Encoder.html">
<link title="BaseEncoder" rel="Chapter" href="BaseEncoder.html">
<link title="Wrap" rel="Chapter" href="Wrap.html">
<link title="Rfc6532" rel="Chapter" href="Rfc6532.html">
<link title="Rfc822" rel="Chapter" href="Rfc822.html">
<link title="Rfc5321" rel="Chapter" href="Rfc5321.html">
<link title="Rfc5322" rel="Chapter" href="Rfc5322.html">
<link title="Rfc6854" rel="Chapter" href="Rfc6854.html">
<link title="Rfc2045" rel="Chapter" href="Rfc2045.html">
<link title="Base64" rel="Chapter" href="Base64.html">
<link title="QuotedPrintable" rel="Chapter" href="QuotedPrintable.html">
<link title="Rfc2046" rel="Chapter" href="Rfc2046.html">
<link title="Rfc2047" rel="Chapter" href="Rfc2047.html">
<link title="Grammar" rel="Chapter" href="Grammar.html"><title>Rfc5322.p_phrase</title>
</head>
<body>
<code class="code">let p_phrase p =
  let is_alpha = function
    | '\x41' .. '\x5a'
    | '\x61' .. '\x7A' -> true
    | chr              -> false
  in
  let is_digit = function
    | '\x30' .. '\x39' -> true
    | chr              -> false
  in
  let is_atext = function
    | '!' | '#'
    | '$' | '%'
    | '&' | '\''
    | '*' | '+'
    | '-' | '/'
    | '=' | '?'
    | '^' | '_'
    | '`' | '{'
    | '|' | '}'
    | '~' -> true
    | chr -> is_digit chr || is_alpha chr
  in
  let is_dquote = (=) '"' in

  let add_fws has_fws element words =
    if has_fws
    then element :: `WSP :: words
    else element :: words
  in

  (* XXX: remove unused FWS, if we don't remove that, the pretty-printer raise
          an error. May be, we fix that in the pretty-printer but I decide to
          fix that in this place. *)
  let rec trim = function
    | `WSP :: r -> trim r
    | r -> r
  in

  let rec obs words =
    p_cfws
    @ fun has_fws -> cur_chr
    @ function
      | '.' ->
        junk_chr @ obs (add_fws has_fws `Dot words)
      | '\x00' .. '\x7F' as chr ->
        if is_atext chr || is_dquote chr
        then Rfc2047.p_try_rule (fun word -> obs (add_fws has_fws word words)) p_word
        else p (trim @@ List.rev @@ trim words)
      | uchar -> p_word @ fun word -> obs (add_fws has_fws word words)
  in

  let rec loop words =
    (* XXX: we catch [p_word] (with its [CFWS] in [p_atom]/[p_quoted_string])
            to determine if we need to switch to [obs] (if we have a '.'),
            or to continue [p_word] *)
    p_cfws
    @ fun has_fws -> cur_chr
    @ function
      | '\x00' .. '\x7F' as chr ->
        if is_atext chr || is_dquote chr
        then Rfc2047.p_try_rule (fun word -> loop (add_fws true word words)) p_word
        else obs (if has_fws then `WSP :: words else words)
      | _ -> obs (if has_fws then `WSP :: words else words)
      (* XXX: may be it's '.' or uchar, so we try to switch to obs *)
  in

  p_fws
  @ fun _ _ ->
    Rfc2047.p_try_rule
      (fun word -> loop [word])
      p_word</code></body></html>